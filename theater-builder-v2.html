<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theater Section Builder - ŸÖŸÜÿ¥ÿ¶ ÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑŸÖÿ≥ÿ±ÿ≠</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 700;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #7c3aed 0%, #ec4899 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            font-family: inherit;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(124, 58, 237, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 11px;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            min-height: calc(100vh - 52px);
        }

        /* Sidebar */
        .sidebar {
            background: rgba(255, 255, 255, 0.03);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px;
            overflow-y: auto;
            max-height: calc(100vh - 52px);
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            color: rgba(255, 255, 255, 0.8);
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-family: inherit;
            font-size: 12px;
        }

        .form-input:focus {
            outline: none;
            border-color: #7c3aed;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        /* Color Picker */
        .color-picker-wrapper {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .color-picker {
            width: 40px;
            height: 32px;
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            padding: 0;
        }

        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        .color-presets {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 6px;
        }

        .color-preset {
            width: 24px;
            height: 24px;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-preset:hover {
            transform: scale(1.1);
        }

        /* Live Preview Box */
        .preview-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 12px 0;
            text-align: center;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-section {
            border: 3px solid #e57373;
            border-radius: 10px 10px 30% 30%;
            padding: 10px 20px;
            display: flex;
            flex-direction: column;
            gap: 3px;
            transition: all 0.3s;
        }

        .preview-row {
            display: flex;
            gap: 3px;
            justify-content: center;
        }

        .preview-seat {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            background: #e57373;
            transition: all 0.3s;
        }

        /* Section List */
        .section-list {
            max-height: 180px;
            overflow-y: auto;
        }

        .section-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .section-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .section-item.selected {
            border-color: #7c3aed;
            background: rgba(124, 58, 237, 0.15);
        }

        .section-color-bar {
            width: 4px;
            height: 30px;
            border-radius: 2px;
        }

        .section-info {
            flex: 1;
        }

        .section-name {
            font-weight: 600;
            font-size: 12px;
        }

        .section-details {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
        }

        .icon-btn {
            width: 22px;
            height: 22px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            font-size: 10px;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .icon-btn.delete:hover {
            background: #ef4444;
        }

        /* Canvas Area */
        .canvas-area {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: auto;
        }

        .theater-name {
            background: transparent;
            border: none;
            font-size: 22px;
            font-weight: 700;
            color: white;
            text-align: center;
            padding: 6px 14px;
            border-bottom: 2px dashed rgba(255, 255, 255, 0.2);
            margin-bottom: 16px;
        }

        .theater-name:focus {
            outline: none;
            border-bottom-color: #7c3aed;
        }

        /* Stage */
        .stage {
            background: linear-gradient(180deg, #4a5568 0%, #2d3748 100%);
            border-radius: 0 0 50% 50%;
            height: 60px;
            width: 45%;
            max-width: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .stage-text {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 5px;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 5px;
            margin-bottom: 16px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .tool-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
        }

        .tool-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tool-btn.active {
            background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
        }

        /* Theater Layout Container */
        .theater-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        /* Section Row - for multiple sections side by side */
        .section-row {
            display: flex;
            gap: 15px;
            justify-content: center;
            width: 100%;
        }

        /* Section Block */
        .theater-section {
            position: relative;
            padding: 12px 15px;
            border-radius: 12px 12px 35% 35%;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            cursor: pointer;
        }

        .theater-section:hover {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        .theater-section.selected {
            box-shadow: 0 0 0 3px #7c3aed;
        }

        .section-label {
            position: absolute;
            top: -8px;
            right: 15px;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
        }

        /* Seat Row */
        .seat-row {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .row-label {
            width: 20px;
            text-align: center;
            font-size: 10px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
        }

        .seats-wrapper {
            display: flex;
            gap: 2px;
            justify-content: center;
        }

        .seat {
            width: 18px;
            height: 18px;
            border-radius: 3px 3px 5px 5px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
        }

        .seat:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .seat.skipped {
            background: #374151 !important;
            opacity: 0.4;
        }

        .seat.pinned {
            border: 2px solid #fbbf24 !important;
        }

        .aisle {
            width: 12px;
        }

        /* Stats */
        .stats-bar {
            display: flex;
            gap: 14px;
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, #7c3aed 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: rgba(255, 255, 255, 0.4);
        }

        .empty-state-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        /* Slider */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 5px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            margin-top: 5px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #7c3aed;
            cursor: pointer;
        }

        /* Edit Section Panel */
        .edit-panel {
            background: rgba(124, 58, 237, 0.1);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .edit-panel-title {
            font-size: 12px;
            font-weight: 600;
            color: #a78bfa;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üé≠</div>
            <span>ŸÖŸÜÿ¥ÿ¶ ÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑŸÖÿ≥ÿ±ÿ≠</span>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="clearAll()">üóëÔ∏è ŸÖÿ≥ÿ≠</button>
            <button class="btn btn-secondary" onclick="exportData()">üì• ÿ™ÿµÿØŸäÿ±</button>
            <button class="btn btn-primary" onclick="previewTheater()">üëÅÔ∏è ŸÖÿπÿßŸäŸÜÿ©</button>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <!-- Add/Edit Section -->
            <div class="sidebar-section">
                <h3 class="sidebar-title" id="sectionFormTitle">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ</h3>

                <div class="form-group">
                    <label class="form-label">ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ</label>
                    <input type="text" class="form-input" id="sectionName" placeholder="VIP, Platinum...">
                </div>

                <div class="form-group">
                    <label class="form-label">ŸÑŸàŸÜ ÿßŸÑŸÇÿ≥ŸÖ</label>
                    <div class="color-picker-wrapper">
                        <input type="color" class="color-picker" id="sectionColor" value="#e57373"
                            oninput="updatePreview()">
                        <input type="text" class="form-input" id="sectionColorText" value="#e57373" style="flex:1">
                    </div>
                    <div class="color-presets">
                        <div class="color-preset" style="background:#e57373" onclick="setColor('#e57373')"></div>
                        <div class="color-preset" style="background:#ba68c8" onclick="setColor('#ba68c8')"></div>
                        <div class="color-preset" style="background:#9575cd" onclick="setColor('#9575cd')"></div>
                        <div class="color-preset" style="background:#7986cb" onclick="setColor('#7986cb')"></div>
                        <div class="color-preset" style="background:#64b5f6" onclick="setColor('#64b5f6')"></div>
                        <div class="color-preset" style="background:#4db6ac" onclick="setColor('#4db6ac')"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ÿµŸÅ ÿßŸÑŸÖŸàŸÇÿπ (ŸÑŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ™ÿ¨ÿßŸàÿ±)</label>
                    <input type="number" class="form-input" id="sectionRowIndex" value="0" min="0"
                        placeholder="0 = ÿµŸÅ ÿ¨ÿØŸäÿØ">
                    <small style="color:rgba(255,255,255,0.4);font-size:10px">ŸÜŸÅÿ≥ ÿßŸÑÿ±ŸÇŸÖ = ŸÜŸÅÿ≥ ÿßŸÑÿµŸÅ (ŸÖÿ™ÿ¨ÿßŸàÿ±)</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ÿßŸÜÿ≠ŸÜÿßÿ°: <span id="curveVal">0</span>%</label>
                        <input type="range" id="sectionCurve" min="0" max="100" value="0"
                            oninput="updateCurvePreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ŸÖŸäŸÑÿßŸÜ: <span id="skewVal">0</span>¬∞</label>
                        <input type="range" id="sectionSkew" min="-30" max="30" value="0" oninput="updateSkewPreview()">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÇÿπÿØ: <span id="seatSizeVal">18</span>px</label>
                        <input type="range" id="sectionSeatSize" min="12" max="40" value="18"
                            oninput="updateSeatSizePreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑŸÖÿ≥ÿßŸÅÿ©: <span id="seatGapVal">2</span>px</label>
                        <input type="range" id="sectionSeatGap" min="0" max="10" value="2"
                            oninput="updateSeatGapPreview()">
                    </div>
                </div>

                <!-- Live Preview -->
                <div class="preview-box">
                    <div class="preview-section" id="livePreview">
                        <div class="preview-row" id="previewRow1">
                            <div class="preview-seat"></div>
                            <div class="preview-seat"></div>
                            <div class="preview-seat"></div>
                        </div>
                        <div class="preview-row" id="previewRow2">
                            <div class="preview-seat"></div>
                            <div class="preview-seat"></div>
                            <div class="preview-seat"></div>
                            <div class="preview-seat"></div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <button class="btn btn-primary" style="flex:1" onclick="saveSection()" id="saveSectionBtn">‚ûï
                        ÿ•ÿ∂ÿßŸÅÿ©</button>
                    <button class="btn btn-secondary" style="flex:1;display:none" onclick="cancelEdit()"
                        id="cancelEditBtn">‚ùå ÿ•ŸÑÿ∫ÿßÿ°</button>
                </div>
            </div>

            <!-- Sections List -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ (<span id="sectionCount">0</span>)</h3>
                <div class="section-list" id="sectionList">
                    <div class="empty-state" style="padding:15px">
                        <p style="font-size:11px">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÇÿ≥ÿßŸÖ</p>
                    </div>
                </div>
            </div>

            <!-- Add Rows to Selected Section -->
            <div class="sidebar-section" id="rowsSection" style="display:none">
                <h3 class="sidebar-title">ÿ•ÿ∂ÿßŸÅÿ© ÿµŸÅŸàŸÅ ŸÑŸÑŸÇÿ≥ŸÖ: <span id="selectedSectionName"></span></h3>
                <div class="form-row-3">
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑÿµŸÅ</label>
                        <input type="text" class="form-input" id="rowName" placeholder="A">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑŸÖŸÇÿßÿπÿØ</label>
                        <input type="number" class="form-input" id="rowSeats" value="10" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑŸÖŸÖÿ±ÿßÿ™</label>
                        <input type="number" class="form-input" id="rowAisles" value="0" min="0" max="5">
                    </div>
                </div>
                <button class="btn btn-primary btn-sm" style="width:100%" onclick="addRow()">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿµŸÅ</button>

                <div id="rowsList" style="margin-top:10px"></div>
            </div>
        </aside>

        <div class="canvas-area">
            <input type="text" class="theater-name" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ±ÿ≠" id="theaterName">

            <div class="toolbar">
                <button class="tool-btn active" id="selectTool" onclick="setTool('select')">üëÜ ÿ™ÿ≠ÿØŸäÿØ</button>
                <button class="tool-btn" id="skipTool" onclick="setTool('skip')">‚õî ÿ™ÿÆÿ∑Ÿä</button>
                <button class="tool-btn" id="pinTool" onclick="setTool('pin')">üìå ÿ™ÿ´ÿ®Ÿäÿ™</button>
            </div>

            <div class="stage">
                <span class="stage-text">ÿßŸÑŸÖÿ≥ÿ±ÿ≠</span>
            </div>

            <div class="theater-layout" id="theaterLayout">
                <div class="empty-state">
                    <div class="empty-state-icon">üé≠</div>
                    <p>ÿßÿ®ÿØÿ£ ÿ®ÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸÇÿ≥ÿßŸÖ</p>
                </div>
            </div>

            <div class="stats-bar" id="statsBar" style="display:none">
                <div class="stat-item">
                    <div class="stat-value" id="totalSeats">0</div>
                    <div class="stat-label">ÿßŸÑŸÖŸÇÿßÿπÿØ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalSections">0</div>
                    <div class="stat-label">ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalRows">0</div>
                    <div class="stat-label">ÿßŸÑÿµŸÅŸàŸÅ</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let sections = [];
        let selectedSectionId = null;
        let editingSection = null;
        let currentTool = 'select';

        // Sync colors
        document.getElementById('sectionColor').addEventListener('input', function () {
            document.getElementById('sectionColorText').value = this.value;
            updatePreview();
        });

        function setColor(c) {
            document.getElementById('sectionColor').value = c;
            document.getElementById('sectionColorText').value = c;
            updatePreview();
        }

        // Live preview updates
        function updatePreview() {
            const color = document.getElementById('sectionColor').value;
            const preview = document.getElementById('livePreview');
            preview.style.borderColor = color;
            preview.querySelectorAll('.preview-seat').forEach(s => s.style.background = color);
        }

        function updateCurvePreview() {
            const curve = document.getElementById('sectionCurve').value;
            document.getElementById('curveVal').textContent = curve;

            const preview = document.getElementById('livePreview');
            const intensity = curve / 100;

            // Apply curve to preview seats
            preview.querySelectorAll('.preview-row').forEach(row => {
                const seats = row.querySelectorAll('.preview-seat');
                seats.forEach((seat, i) => {
                    const total = seats.length;
                    const normalized = total > 1 ? (i - (total - 1) / 2) / ((total - 1) / 2) : 0;
                    const yOffset = Math.pow(normalized, 2) * intensity * 15;
                    const rotation = normalized * intensity * 10;
                    seat.style.transform = `translateY(-${yOffset}px) rotate(${rotation}deg)`;
                });
            });

            // Update selected section in real-time
            if (editingSection) {
                const section = sections.find(s => s.id === editingSection);
                if (section) {
                    section.curve = parseInt(curve);
                    renderCanvas();
                }
            }
        }

        function updateSkewPreview() {
            const skew = document.getElementById('sectionSkew').value;
            document.getElementById('skewVal').textContent = skew;

            const preview = document.getElementById('livePreview');
            const curve = document.getElementById('sectionCurve').value;
            preview.style.transform = `skewX(${skew}deg)`;

            // Update selected section in real-time
            if (editingSection) {
                const section = sections.find(s => s.id === editingSection);
                if (section) {
                    section.skew = parseInt(skew);
                    renderCanvas();
                }
            }
        }

        function updateSeatSizePreview() {
            const size = document.getElementById('sectionSeatSize').value;
            document.getElementById('seatSizeVal').textContent = size;

            const preview = document.getElementById('livePreview');
            preview.querySelectorAll('.preview-seat').forEach(s => {
                s.style.width = size + 'px';
                s.style.height = size + 'px';
            });

            if (editingSection) {
                const section = sections.find(s => s.id === editingSection);
                if (section) {
                    section.seatSize = parseInt(size);
                    renderCanvas();
                }
            }
        }

        function updateSeatGapPreview() {
            const gap = document.getElementById('sectionSeatGap').value;
            document.getElementById('seatGapVal').textContent = gap;

            const preview = document.getElementById('livePreview');
            preview.querySelectorAll('.preview-row').forEach(r => {
                r.style.gap = gap + 'px';
            });

            if (editingSection) {
                const section = sections.find(s => s.id === editingSection);
                if (section) {
                    section.seatGap = parseInt(gap);
                    renderCanvas();
                }
            }
        }

        // Save section (add or update)
        function saveSection() {
            const name = document.getElementById('sectionName').value.trim() || `Section ${sections.length + 1}`;
            const color = document.getElementById('sectionColor').value;
            const curve = parseInt(document.getElementById('sectionCurve').value);
            const skew = parseInt(document.getElementById('sectionSkew').value);
            const seatSize = parseInt(document.getElementById('sectionSeatSize').value);
            const seatGap = parseInt(document.getElementById('sectionSeatGap').value);
            const rowIndex = parseInt(document.getElementById('sectionRowIndex').value) || 0;

            if (editingSection) {
                // Update existing
                const section = sections.find(s => s.id === editingSection);
                if (section) {
                    section.name = name;
                    section.color = color;
                    section.curve = curve;
                    section.skew = skew;
                    section.seatSize = seatSize;
                    section.seatGap = seatGap;
                    section.rowIndex = rowIndex;
                }
                editingSection = null;
            } else {
                // Add new
                sections.push({
                    id: Date.now(),
                    name,
                    color,
                    curve,
                    skew,
                    seatSize,
                    seatGap,
                    rowIndex,
                    rows: []
                });
            }

            resetForm();
            renderSections();
            renderCanvas();
        }

        function resetForm() {
            document.getElementById('sectionName').value = '';
            document.getElementById('sectionCurve').value = 0;
            document.getElementById('sectionSkew').value = 0;
            document.getElementById('sectionSeatSize').value = 18;
            document.getElementById('sectionSeatGap').value = 2;
            document.getElementById('sectionRowIndex').value = 0;
            document.getElementById('curveVal').textContent = '0';
            document.getElementById('skewVal').textContent = '0';
            document.getElementById('seatSizeVal').textContent = '18';
            document.getElementById('seatGapVal').textContent = '2';
            document.getElementById('livePreview').style.transform = '';
            document.getElementById('livePreview').querySelectorAll('.preview-seat').forEach(s => {
                s.style.transform = '';
                s.style.width = '12px';
                s.style.height = '12px';
            });
            document.getElementById('livePreview').querySelectorAll('.preview-row').forEach(r => r.style.gap = '3px');
            document.getElementById('sectionFormTitle').textContent = '‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ';
            document.getElementById('saveSectionBtn').textContent = '‚ûï ÿ•ÿ∂ÿßŸÅÿ©';
            document.getElementById('cancelEditBtn').style.display = 'none';
            editingSection = null;
            updatePreview();
        }

        function cancelEdit() {
            resetForm();
        }

        // Edit section
        function editSection(id) {
            const section = sections.find(s => s.id === id);
            if (!section) return;

            editingSection = id;
            document.getElementById('sectionName').value = section.name;
            document.getElementById('sectionColor').value = section.color;
            document.getElementById('sectionColorText').value = section.color;
            document.getElementById('sectionCurve').value = section.curve;
            document.getElementById('sectionSkew').value = section.skew;
            document.getElementById('sectionSeatSize').value = section.seatSize || 18;
            document.getElementById('sectionSeatGap').value = section.seatGap || 2;
            document.getElementById('sectionRowIndex').value = section.rowIndex || 0;
            document.getElementById('curveVal').textContent = section.curve;
            document.getElementById('skewVal').textContent = section.skew;
            document.getElementById('seatSizeVal').textContent = section.seatSize || 18;
            document.getElementById('seatGapVal').textContent = section.seatGap || 2;
            document.getElementById('sectionFormTitle').textContent = '‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÇÿ≥ŸÖ';
            document.getElementById('saveSectionBtn').textContent = 'üíæ ÿ≠ŸÅÿ∏';
            document.getElementById('cancelEditBtn').style.display = 'block';

            updatePreview();
            updateCurvePreview();
            updateSkewPreview();
            updateSeatSizePreview();
            updateSeatGapPreview();
        }

        // Render sections list
        function renderSections() {
            const list = document.getElementById('sectionList');
            document.getElementById('sectionCount').textContent = sections.length;

            if (sections.length === 0) {
                list.innerHTML = '<div class="empty-state" style="padding:15px"><p style="font-size:11px">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÇÿ≥ÿßŸÖ</p></div>';
                document.getElementById('rowsSection').style.display = 'none';
                return;
            }

            list.innerHTML = sections.map(s => `
                <div class="section-item ${selectedSectionId === s.id ? 'selected' : ''}" onclick="selectSection(${s.id})">
                    <div class="section-color-bar" style="background:${s.color}"></div>
                    <div class="section-info">
                        <div class="section-name">${s.name}</div>
                        <div class="section-details">${s.rows.length} ÿµŸÅ ‚Ä¢ ${s.rows.reduce((sum, r) => sum + r.seats.length, 0)} ŸÖŸÇÿπÿØ</div>
                    </div>
                    <button class="icon-btn" onclick="event.stopPropagation();editSection(${s.id})">‚úèÔ∏è</button>
                    <button class="icon-btn delete" onclick="event.stopPropagation();deleteSection(${s.id})">‚úï</button>
                </div>
            `).join('');
        }

        // Select section for adding rows
        function selectSection(id) {
            selectedSectionId = id;
            renderSections();
            renderCanvas();

            const section = sections.find(s => s.id === id);
            if (section) {
                document.getElementById('rowsSection').style.display = 'block';
                document.getElementById('selectedSectionName').textContent = section.name;
                renderRowsList();
            }
        }

        // Delete section
        function deleteSection(id) {
            sections = sections.filter(s => s.id !== id);
            if (selectedSectionId === id) selectedSectionId = null;
            if (editingSection === id) resetForm();
            renderSections();
            renderCanvas();
        }

        // Add row to selected section
        function addRow() {
            const section = sections.find(s => s.id === selectedSectionId);
            if (!section) return;

            const name = document.getElementById('rowName').value.trim() || getNextRowName(section);
            const seats = parseInt(document.getElementById('rowSeats').value) || 10;
            const aisles = parseInt(document.getElementById('rowAisles').value) || 0;

            section.rows.push({
                id: Date.now(),
                name,
                aisles,
                seats: Array.from({ length: seats }, (_, i) => ({
                    number: i + 1,
                    status: 'available'
                }))
            });

            document.getElementById('rowName').value = '';
            renderRowsList();
            renderSections();
            renderCanvas();
        }

        function getNextRowName(section) {
            if (section.rows.length === 0) return 'A';
            const last = section.rows[section.rows.length - 1].name;
            if (last.length === 1 && last.charCodeAt(0) >= 65 && last.charCodeAt(0) < 90) {
                return String.fromCharCode(last.charCodeAt(0) + 1);
            }
            return `R${section.rows.length + 1}`;
        }

        function renderRowsList() {
            const section = sections.find(s => s.id === selectedSectionId);
            const container = document.getElementById('rowsList');
            if (!section || section.rows.length === 0) {
                container.innerHTML = '<p style="font-size:10px;color:rgba(255,255,255,0.4);text-align:center">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸÅŸàŸÅ</p>';
                return;
            }

            container.innerHTML = section.rows.map((r, i) => `
                <div style="display:flex;align-items:center;gap:6px;padding:6px;background:rgba(255,255,255,0.05);border-radius:5px;margin-bottom:4px;font-size:11px">
                    <span style="flex:1">ÿµŸÅ ${r.name} (${r.seats.length} ŸÖŸÇÿπÿØ${r.aisles > 0 ? ' ‚Ä¢ ' + r.aisles + ' ŸÖŸÖÿ±' : ''})</span>
                    <button class="icon-btn" onclick="deleteRow(${i})">‚úï</button>
                </div>
            `).join('');
        }

        function deleteRow(idx) {
            const section = sections.find(s => s.id === selectedSectionId);
            if (section) {
                section.rows.splice(idx, 1);
                renderRowsList();
                renderSections();
                renderCanvas();
            }
        }

        // Render canvas with sections in rows
        function renderCanvas() {
            const container = document.getElementById('theaterLayout');
            const statsBar = document.getElementById('statsBar');

            if (sections.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üé≠</div><p>ÿßÿ®ÿØÿ£ ÿ®ÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸÇÿ≥ÿßŸÖ</p></div>';
                statsBar.style.display = 'none';
                return;
            }

            statsBar.style.display = 'flex';
            updateStats();

            // Group sections by rowIndex
            const rowGroups = {};
            sections.forEach(s => {
                const idx = s.rowIndex || 0;
                if (!rowGroups[idx]) rowGroups[idx] = [];
                rowGroups[idx].push(s);
            });

            // Sort row indices
            const sortedIndices = Object.keys(rowGroups).map(Number).sort((a, b) => a - b);

            container.innerHTML = sortedIndices.map(idx => {
                const sectionsInRow = rowGroups[idx];
                return `
                    <div class="section-row">
                        ${sectionsInRow.map(section => renderSection(section)).join('')}
                    </div>
                `;
            }).join('');
        }

        function calculateSectionBorderPoints(section) {
            const points = [];
            const seatSize = section.seatSize || 18;
            const seatGap = section.seatGap || 2;
            const curve = section.curve / 100;
            const skew = section.skew;

            section.rows.forEach((row, rowIndex) => {
                const seatsArr = row.seats;
                const aisles = row.aisles || 0;
                let seatIndex = 0;

                if (aisles > 0) {
                    const groupSize = Math.ceil(seatsArr.length / (aisles + 1));
                    for (let i = 0; i < seatsArr.length; i += groupSize) {
                        const group = seatsArr.slice(i, i + groupSize);
                        group.forEach((s, si) => {
                            const globalIdx = seatIndex;
                            const x = (globalIdx * (seatSize + seatGap)) + (aisles * 12);
                            const normalized = seatsArr.length > 1 ? (globalIdx - (seatsArr.length - 1) / 2) / ((seatsArr.length - 1) / 2) : 0;
                            const yOffset = Math.pow(normalized, 2) * curve * 15;
                            const rotation = normalized * curve * 8;
                            
                            const rad = rotation * Math.PI / 180;
                            const cos = Math.cos(rad);
                            const sin = Math.sin(rad);
                            
                            const localX = x;
                            const localY = rowIndex * (seatSize + 6) - yOffset;
                            
                            const rotatedX = localX * cos - localY * sin;
                            const rotatedY = localX * sin + localY * cos;
                            
                            const skewOffset = rotatedY * Math.tan(skew * Math.PI / 180);
                            const finalX = rotatedX + skewOffset;
                            
                            if (si === 0 && i === 0) {
                                points.push({ x: finalX, y: rotatedY, row: rowIndex, side: 'left' });
                            }
                            if (si === group.length - 1 && i + groupSize >= seatsArr.length) {
                                points.push({ x: finalX + seatSize, y: rotatedY, row: rowIndex, side: 'right' });
                            }
                            seatIndex++;
                        });
                    }
                } else {
                    seatsArr.forEach((s, i) => {
                        const x = i * (seatSize + seatGap);
                        const normalized = seatsArr.length > 1 ? (i - (seatsArr.length - 1) / 2) / ((seatsArr.length - 1) / 2) : 0;
                        const yOffset = Math.pow(normalized, 2) * curve * 15;
                        const rotation = normalized * curve * 8;
                        
                        const rad = rotation * Math.PI / 180;
                        const cos = Math.cos(rad);
                        const sin = Math.sin(rad);
                        
                        const localX = x;
                        const localY = rowIndex * (seatSize + 6) - yOffset;
                        
                        const rotatedX = localX * cos - localY * sin;
                        const rotatedY = localX * sin + localY * cos;
                        
                        const skewOffset = rotatedY * Math.tan(skew * Math.PI / 180);
                        const finalX = rotatedX + skewOffset;
                        
                        if (i === 0) {
                            points.push({ x: finalX, y: rotatedY, row: rowIndex, side: 'left' });
                        }
                        if (i === seatsArr.length - 1) {
                            points.push({ x: finalX + seatSize, y: rotatedY, row: rowIndex, side: 'right' });
                        }
                    });
                }
            });

            return points;
        }

        function generateSectionBorderPath(points) {
            if (points.length === 0) return '';

            const leftPoints = points.filter(p => p.side === 'left').sort((a, b) => b.y - a.y);
            const rightPoints = points.filter(p => p.side === 'right').sort((a, b) => a.y - b.y);

            const padding = 15;
            const bottomPadding = 20;
            const topPadding = 20;

            if (leftPoints.length === 0 || rightPoints.length === 0) return '';

            const topLeft = leftPoints[0];
            const bottomLeft = leftPoints[leftPoints.length - 1];
            const topRight = rightPoints[0];
            const bottomRight = rightPoints[rightPoints.length - 1];

            const startX = Math.min(topLeft.x, bottomLeft.x) - padding;
            const endX = Math.max(topRight.x, bottomRight.x) + padding;
            const startY = Math.min(topLeft.y, topRight.y) - topPadding;
            const endY = Math.max(bottomLeft.y, bottomRight.y) + bottomPadding;

            const cornerRadius = 30;
            
            let path = `M ${startX + cornerRadius} ${startY}`;
            path += ` L ${endX - cornerRadius} ${startY}`;
            path += ` Q ${endX} ${startY} ${endX} ${startY + cornerRadius}`;
            path += ` L ${endX} ${endY - cornerRadius}`;
            path += ` Q ${endX} ${endY} ${endX - cornerRadius} ${endY}`;
            path += ` L ${startX + cornerRadius} ${endY}`;
            path += ` Q ${startX} ${endY} ${startX} ${endY - cornerRadius}`;
            path += ` L ${startX} ${startY + cornerRadius}`;
            path += ` Q ${startX} ${startY} ${startX + cornerRadius} ${startY}`;
            path += ' Z';

            return path;
        }

        function renderSection(section) {
            const skewStyle = section.skew !== 0 ? `transform: skewX(${section.skew}deg);` : '';
            const borderPoints = calculateSectionBorderPoints(section);
            const borderPath = generateSectionBorderPath(borderPoints);

            let svgBorder = '';
            if (borderPath) {
                svgBorder = `
                    <svg style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:visible">
                        <path d="${borderPath}" 
                              fill="none" 
                              stroke="${section.color}" 
                              stroke-width="3" 
                              stroke-linejoin="round"/>
                    </svg>
                `;
            }

            return `
                <div class="theater-section ${selectedSectionId === section.id ? 'selected' : ''}"
                     style="border: none; ${skewStyle}"
                     onclick="selectSection(${section.id})">
                    ${svgBorder}
                    <span class="section-label" style="background:${section.color}">${section.name}</span>
                    ${section.rows.map(row => renderRow(section, row)).join('')}
                </div>
            `;
        }

        function renderRow(section, row) {
            const seatsArr = row.seats;
            const aisles = row.aisles || 0;
            const seatGap = section.seatGap || 2;

            let seatsHTML = '';
            if (aisles > 0) {
                // Distribute seats with aisles
                const seatGroups = [];
                const groupSize = Math.ceil(seatsArr.length / (aisles + 1));
                for (let i = 0; i < seatsArr.length; i += groupSize) {
                    seatGroups.push(seatsArr.slice(i, i + groupSize));
                }

                seatsHTML = seatGroups.map((group, gi) => {
                    const groupSeats = group.map((s, si) => {
                        const globalIdx = gi * groupSize + si;
                        return renderSeat(section, row, s, globalIdx, seatsArr.length);
                    }).join('');
                    return groupSeats + (gi < seatGroups.length - 1 ? '<div class="aisle"></div>' : '');
                }).join('');
            } else {
                seatsHTML = seatsArr.map((s, i) => renderSeat(section, row, s, i, seatsArr.length)).join('');
            }

            return `
                <div class="seat-row">
                    <div class="row-label">${row.name}</div>
                    <div class="seats-wrapper" style="gap:${seatGap}px">${seatsHTML}</div>
                    <div class="row-label">${row.name}</div>
                </div>
            `;
        }

        function renderSeat(section, row, seat, index, total) {
            const statusClass = seat.status !== 'available' ? seat.status : '';
            const seatSize = section.seatSize || 18;
            const fontSize = Math.max(7, Math.floor(seatSize * 0.4));

            // Curve transform
            let transform = '';
            if (section.curve > 0) {
                const intensity = section.curve / 100;
                const normalized = total > 1 ? (index - (total - 1) / 2) / ((total - 1) / 2) : 0;
                const yOffset = Math.pow(normalized, 2) * intensity * 15;
                const rotation = normalized * intensity * 8;
                transform = `transform: translateY(-${yOffset}px) rotate(${rotation}deg);`;
            }

            return `
                <div class="seat ${statusClass}"
                     style="width:${seatSize}px; height:${seatSize}px; font-size:${fontSize}px; background:${seat.status === 'skipped' ? '' : section.color}; ${transform}"
                     onclick="event.stopPropagation();handleSeatClick(${section.id}, ${row.id}, ${seat.number})"
                     title="ÿµŸÅ ${row.name} - ŸÖŸÇÿπÿØ ${seat.number}">
                    ${seat.status === 'available' ? seat.number : ''}
                </div>
            `;
        }

        function handleSeatClick(sectionId, rowId, seatNum) {
            const section = sections.find(s => s.id === sectionId);
            if (!section) return;
            const row = section.rows.find(r => r.id === rowId);
            if (!row) return;
            const seat = row.seats.find(s => s.number === seatNum);
            if (!seat) return;

            if (currentTool === 'skip') {
                seat.status = seat.status === 'skipped' ? 'available' : 'skipped';
            } else if (currentTool === 'pin') {
                seat.status = seat.status === 'pinned' ? 'available' : 'pinned';
            }

            renderCanvas();
        }

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tool + 'Tool').classList.add('active');
        }

        function updateStats() {
            let seats = 0, rows = 0;
            sections.forEach(s => {
                rows += s.rows.length;
                s.rows.forEach(r => seats += r.seats.filter(seat => seat.status !== 'skipped').length);
            });
            document.getElementById('totalSeats').textContent = seats;
            document.getElementById('totalSections').textContent = sections.length;
            document.getElementById('totalRows').textContent = rows;
        }

        // LocalStorage persistence
        function saveToStorage() {
            const data = {
                theaterName: document.getElementById('theaterName').value,
                sections: sections
            };
            localStorage.setItem('theaterBuilderData', JSON.stringify(data));
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('theaterBuilderData');
                if (saved) {
                    const data = JSON.parse(saved);
                    sections = data.sections || [];
                    document.getElementById('theaterName').value = data.theaterName || '';
                    renderSections();
                    renderCanvas();
                }
            } catch (e) {
                console.error('Error loading saved data:', e);
            }
        }

        // Auto-save after any change
        const originalRenderCanvas = renderCanvas;
        renderCanvas = function () {
            originalRenderCanvas();
            saveToStorage();
        };

        function clearAll() {
            if (confirm('ŸÖÿ≥ÿ≠ ŸÉŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿü')) {
                sections = [];
                selectedSectionId = null;
                editingSection = null;
                localStorage.removeItem('theaterBuilderData');
                resetForm();
                renderSections();
                renderCanvas();
            }
        }

        function exportData() {
            const data = { name: document.getElementById('theaterName').value, sections };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'theater-layout.json';
            a.click();
        }

        function previewTheater() {
            alert('Ÿäÿ™ŸÖ ŸÅÿ™ÿ≠ ÿßŸÑŸÖÿπÿßŸäŸÜÿ© ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ÿ¨ÿØŸäÿØÿ©');
            const preview = window.open('', '_blank');
            preview.document.write(`
                <html><head><title>ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÖÿ≥ÿ±ÿ≠</title>
                <style>body{background:#1a1a2e;color:white;font-family:Cairo,sans-serif;padding:40px;display:flex;flex-direction:column;align-items:center}</style>
                </head><body>
                <h2>${document.getElementById('theaterName').value || 'ÿßŸÑŸÖÿ≥ÿ±ÿ≠'}</h2>
                ${document.getElementById('theaterLayout').innerHTML}
                </body></html>
            `);
        }

        // Save theater name on change
        document.getElementById('theaterName').addEventListener('input', saveToStorage);

        // Init
        updatePreview();
        setTool('select');
        loadFromStorage();
    </script>
</body>

</html>